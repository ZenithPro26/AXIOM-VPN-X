name: ğŸ’  AXIOM-VPN-X DEBUG BUILD (Self-Healing)

on:
  workflow_dispatch:

jobs:
  build-axiom-vpn:
    runs-on: ubuntu-latest
    
    steps:
      # 1. CLONAR REPO
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4

      # 2. JAVA 21 (Requerido)
      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      # 3. NODE.JS
      - name: âš›ï¸ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 4. ğŸ§  CONSTRUCCIÃ“N UI BLINDADA (AUTO-GÃ‰NESIS)
      - name: ğŸ§  Build React UI & Inject Assets
        run: |
          echo ">>> ğŸ›¡ï¸ PROTOCOLO DE AUTO-GÃ‰NESIS DE ARCHIVOS..."
          
          # 1. RECREAR package.json (Si falta)
          if [ ! -f "package.json" ]; then
            echo ">>> Generando package.json..."
            cat <<EOF > package.json
          {
            "name": "axiom-vpn-ui",
            "private": true,
            "version": "2.5.0",
            "type": "module",
            "scripts": {
              "dev": "vite",
              "build": "vite build",
              "preview": "vite preview"
            },
            "dependencies": {
              "react": "^18.2.0",
              "react-dom": "^18.2.0",
              "lucide-react": "^0.344.0",
              "recharts": "^2.12.0",
              "react-is": "^18.2.0"
            },
            "devDependencies": {
              "@types/react": "^18.2.66",
              "@types/react-dom": "^18.2.22",
              "@vitejs/plugin-react": "^4.2.1",
              "typescript": "^5.2.2",
              "vite": "^5.2.0"
            }
          }
          EOF
          fi

          # 2. RECREAR vite.config.ts (Si falta)
          if [ ! -f "vite.config.ts" ]; then
            echo ">>> Generando vite.config.ts..."
            cat <<EOF > vite.config.ts
          import path from 'path';
          import { defineConfig } from 'vite';
          import react from '@vitejs/plugin-react';

          export default defineConfig({
            base: './',
            plugins: [react()],
            resolve: {
              alias: {
                '@': path.resolve(__dirname, '.'),
                'react-is': path.resolve(__dirname, 'node_modules/react-is')
              }
            },
            build: {
              outDir: 'dist',
              assetsDir: 'assets',
              emptyOutDir: true,
              rollupOptions: {
                output: {
                  manualChunks: {
                    vendor: ['react', 'react-dom', 'recharts'],
                  },
                },
              },
            }
          });
          EOF
          fi

          # 3. INSTALACIÃ“N Y BUILD
          echo ">>> Instalando dependencias..."
          npm install --legacy-peer-deps
          
          echo ">>> Compilando React..."
          npm run build
          
          # 4. INYECCIÃ“N
          echo ">>> Inyectando en Android Assets..."
          rm -rf app/src/main/assets
          mkdir -p app/src/main/assets
          
          if [ -d "dist" ]; then
            cp -r dist/* app/src/main/assets/
            echo "âœ… UI Inyectada."
          else
            echo "âš ï¸ ERROR CRÃTICO: React build fallÃ³. Usando Fallback."
            echo "<html><body style='background:#000;color:red'><h1>UI BUILD ERROR</h1></body></html>" > app/src/main/assets/index.html
          fi

      # 5. ğŸ˜ REPARACIÃ“N AUTOMÃTICA DE GRADLE WRAPPER
      - name: ğŸ˜ Fix Missing Gradle Wrapper
        run: |
          mkdir -p gradle/wrapper
          cat > gradle/wrapper/gradle-wrapper.properties <<EOF
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-9.3-bin.zip
          networkTimeout=10000
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
          
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            wget -q https://raw.githubusercontent.com/gradle/gradle/master/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar
          fi

      # 6. ğŸ¨ GENERACIÃ“N DE RECURSOS
      - name: ğŸ¨ Generate Resources
        run: |
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/drawable
          
          echo '<resources><string name="app_name">Axiom VPN X</string></resources>' > app/src/main/res/values/strings.xml
          
          cat <<EOF > app/src/main/res/values/themes.xml
          <resources>
              <style name="Theme.AxiomLink" parent="android:Theme.Material.NoActionBar.Fullscreen">
                  <item name="android:statusBarColor">#050505</item>
                  <item name="android:navigationBarColor">#050505</item>
              </style>
          </resources>
          EOF
          
          # Iconos Dummy para que no falle
          cat <<EOF > app/src/main/res/drawable/ic_launcher.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108"><path android:fillColor="#1f538d" android:pathData="M0,0h108v108h-108z"/></vector>
          EOF
          cp app/src/main/res/drawable/ic_launcher.xml app/src/main/res/drawable/ic_launcher_round.xml
          cp app/src/main/res/drawable/ic_launcher.xml app/src/main/res/drawable/ic_notification.xml

      # 7. ğŸ”§ PERMISOS
      - name: ğŸ”§ Grant Permissions
        run: chmod +x gradlew

      # 8. ğŸ”¨ COMPILAR
      - name: ğŸ”¨ Build Debug APK
        run: ./gradlew assembleDebug --stacktrace --warning-mode=all

      # 9. ğŸ“¥ SUBIR
      - name: ğŸ“¥ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AxiomVPN-X-Debug
          path: app/build/outputs/apk/debug/*.apk
