name: üí† AXIOM-VPN-X DEBUG BUILD (Auto-Fix)

on:
  workflow_dispatch: # Activaci√≥n manual con bot√≥n

jobs:
  build-axiom-vpn:
    runs-on: ubuntu-latest
    
    steps:
      # ------------------------------------------------------------
      # 1. üõ∞Ô∏è OBTENER C√ìDIGO
      # ------------------------------------------------------------
      - name: üõ∞Ô∏è Checkout Repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2. ‚òï PREPARAR ENTORNO (JAVA 21 OBLIGATORIO PARA AGP 9.0)
      # ------------------------------------------------------------
      - name: ‚òï Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      # ------------------------------------------------------------
      # 3. ‚öõÔ∏è PREPARAR NODE.JS
      # ------------------------------------------------------------
      - name: ‚öõÔ∏è Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ------------------------------------------------------------
      # 4. üß† CONSTRUIR UI (REACT) + INYECCI√ìN
      # ------------------------------------------------------------
      - name: üß† Build React UI & Inject Assets
        run: |
          echo ">>> Instalando dependencias..."
          npm install --legacy-peer-deps
          
          echo ">>> Construyendo Frontend (Vite)..."
          # Esto generar√° la carpeta 'dist'
          npm run build
          
          echo ">>> Limpiando e Inyectando Assets..."
          # Borramos assets antiguos para asegurar limpieza
          rm -rf app/src/main/assets
          mkdir -p app/src/main/assets
          
          if [ -d "dist" ]; then
            # Copiamos todo el contenido de dist a assets
            cp -r dist/* app/src/main/assets/
            echo "‚úÖ UI Inyectada: $(ls app/src/main/assets/ | wc -l) archivos."
          else
            echo "‚ö†Ô∏è ERROR: Fall√≥ build de React. Creando fallback de emergencia..."
            echo "<html><body style='background:#050505;color:#1f538d;display:flex;justify-content:center;align-items:center;height:100vh;font-family:monospace;'><h1>AXIOM VPN CORE ACTIVE<br><small>UI Build Failed</small></h1></body></html>" > app/src/main/assets/index.html
          fi

      # ------------------------------------------------------------
      # 5. üêò REPARACI√ìN AUTOM√ÅTICA DE GRADLE WRAPPER
      # ------------------------------------------------------------
      - name: üêò Fix Missing Gradle Wrapper
        run: |
          echo ">>> Verificando integridad del Wrapper..."
          mkdir -p gradle/wrapper
          
          # 1. Crear gradle-wrapper.properties apuntando a Gradle 9.3
          cat > gradle/wrapper/gradle-wrapper.properties <<EOF
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-9.3-bin.zip
          networkTimeout=10000
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
          
          # 2. Descargar el JAR si no existe (CR√çTICO)
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo ">>> Descargando gradle-wrapper.jar faltante..."
            wget -q https://raw.githubusercontent.com/gradle/gradle/master/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar
          fi
          
          echo "‚úÖ Wrapper reparado."

      # ------------------------------------------------------------
      # 6. üé® GENERACI√ìN DE RECURSOS (ICONOS Y TEMAS)
      # ------------------------------------------------------------
      - name: üé® Generate Resources (Self-Healing)
        run: |
          echo ">>> Generando estructura de recursos..."
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/drawable
          
          # Strings
          echo '<resources><string name="app_name">Axiom VPN X</string></resources>' > app/src/main/res/values/strings.xml
          
          # Tema (Sin ActionBar para pantalla completa)
          cat <<EOF > app/src/main/res/values/themes.xml
          <resources>
              <style name="Theme.AppCompat.NoActionBar" parent="android:Theme.Material.NoActionBar.Fullscreen">
                  <item name="android:statusBarColor">#050505</item>
                  <item name="android:navigationBarColor">#050505</item>
              </style>
          </resources>
          EOF
          
          # Icono Launcher (Escudo AXIOM)
          cat <<EOF > app/src/main/res/drawable/ic_launcher.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#050505" android:pathData="M0,0h108v108h-108z"/>
              <path android:fillColor="#1f538d" android:pathData="M54,14L24,26V56C24,77 38,96 54,104C70,96 84,77 84,56V26L54,14Z"/>
          </vector>
          EOF
          
          # Icono Notificaci√≥n
          cat <<EOF > app/src/main/res/drawable/ic_notification.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="24dp" android:height="24dp" android:viewportWidth="24" android:viewportHeight="24">
              <path android:fillColor="#FFFFFF" android:pathData="M12,2L4,5V10C4,15.25 7.5,20.1 12,22C16.5,20.1 20,15.25 20,10V5L12,2Z"/>
          </vector>
          EOF
          
          cp app/src/main/res/drawable/ic_launcher.xml app/src/main/res/drawable/ic_launcher_round.xml

      # ------------------------------------------------------------
      # 7. üîß PERMISOS DE EJECUCI√ìN
      # ------------------------------------------------------------
      - name: üîß Grant Permissions
        run: chmod +x gradlew

      # ------------------------------------------------------------
      # 8. üî® COMPILAR APK (MODO DEBUG)
      # ------------------------------------------------------------
      - name: üî® Build Debug APK
        run: ./gradlew assembleDebug --stacktrace --warning-mode=all
