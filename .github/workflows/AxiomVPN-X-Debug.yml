name: ðŸ’  AXIOM-VPN-X DEBUG BUILD (Full Genesis)

on:
  workflow_dispatch:

jobs:
  build-axiom-vpn:
    runs-on: ubuntu-latest
    
    steps:
      # 1. CLONAR REPO
      - name: ðŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4

      # 2. JAVA 21 (Requerido)
      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      # 3. NODE.JS
      - name: âš›ï¸ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 4. ðŸ§  CONSTRUCCIÃ“N UI BLINDADA (AUTO-GÃ‰NESIS TOTAL)
      - name: ðŸ§  Build React UI & Inject Assets
        run: |
          echo ">>> ðŸ›¡ï¸ PROTOCOLO DE AUTO-GÃ‰NESIS DE ARCHIVOS..."
          
          # A. RECREAR package.json (Si falta)
          if [ ! -f "package.json" ]; then
            echo ">>> Generando package.json..."
            cat <<EOF > package.json
          {
            "name": "axiom-vpn-ui",
            "private": true,
            "version": "2.5.0",
            "type": "module",
            "scripts": { "build": "vite build" },
            "dependencies": {
              "react": "^18.2.0",
              "react-dom": "^18.2.0",
              "lucide-react": "^0.344.0",
              "recharts": "^2.12.0",
              "react-is": "^18.2.0"
            },
            "devDependencies": {
              "@types/react": "^18.2.66",
              "@types/react-dom": "^18.2.22",
              "@vitejs/plugin-react": "^4.2.1",
              "typescript": "^5.2.2",
              "vite": "^5.2.0"
            }
          }
          EOF
          fi

          # B. RECREAR vite.config.ts (Si falta)
          if [ ! -f "vite.config.ts" ]; then
            echo ">>> Generando vite.config.ts..."
            cat <<EOF > vite.config.ts
          import path from 'path';
          import { defineConfig } from 'vite';
          import react from '@vitejs/plugin-react';

          export default defineConfig({
            base: './',
            plugins: [react()],
            resolve: {
              alias: {
                '@': path.resolve(__dirname, '.'),
                'react-is': path.resolve(__dirname, 'node_modules/react-is')
              }
            },
            build: {
              outDir: 'dist',
              assetsDir: 'assets',
              emptyOutDir: true
            }
          });
          EOF
          fi

          # C. RECREAR index.html (EL ERROR QUE TE DIO)
          if [ ! -f "index.html" ]; then
            echo ">>> Generando index.html..."
            cat <<EOF > index.html
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>AXIOM-LINK</title>
              <script src="https://cdn.tailwindcss.com"></script>
              <style>body { background-color: #050505; color: #e5e5e5; }</style>
            </head>
            <body>
              <div id="root"></div>
              <script type="module" src="/index.tsx"></script>
            </body>
          </html>
          EOF
          fi

          # D. RECREAR index.tsx (Punto de entrada)
          if [ ! -f "index.tsx" ]; then
            echo ">>> Generando index.tsx..."
            cat <<EOF > index.tsx
          import React from 'react';
          import ReactDOM from 'react-dom/client';
          import App from './App';
          ReactDOM.createRoot(document.getElementById('root')!).render(
            <React.StrictMode><App /></React.StrictMode>
          );
          EOF
          fi

          # E. RECREAR App.tsx (Interfaz BÃ¡sica Cyber-Dark de Respaldo)
          if [ ! -f "App.tsx" ]; then
            echo ">>> Generando App.tsx (Backup UI)..."
            cat <<EOF > App.tsx
          import React, { useState } from 'react';
          import { Shield, Zap } from 'lucide-react';

          export default function App() {
            const [active, setActive] = useState(false);
            
            const toggle = () => {
               if(window.AxiomCore) {
                 if(!active) window.AxiomCore.startService();
                 else window.AxiomCore.stopService();
               }
               setActive(!active);
            }

            return (
              <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-[#050505] text-white font-mono">
                <div className="mb-8 p-4 border border-[#1f538d] rounded-lg bg-[#0a0a0a]">
                  <h1 className="text-2xl font-bold flex items-center gap-2">
                    <Shield className="text-[#1f538d]" /> AXIOM-LINK
                  </h1>
                  <p className="text-xs text-gray-500 mt-2">SECURE TUNNELING PROTOCOL</p>
                </div>
                
                <button 
                  onClick={toggle}
                  className={\`w-48 h-48 rounded-full border-4 flex flex-col items-center justify-center transition-all duration-500 \${active ? 'border-[#00ff9d] shadow-[0_0_30px_#00ff9d]' : 'border-[#1f1f1f]'}\`}
                >
                  <Zap size={64} className={active ? 'text-[#00ff9d]' : 'text-gray-600'} />
                  <span className="mt-4 font-bold">{active ? 'ONLINE' : 'OFFLINE'}</span>
                </button>
              </div>
            );
          }
          EOF
          fi

          # 3. INSTALACIÃ“N Y BUILD
          echo ">>> Instalando dependencias..."
          npm install --legacy-peer-deps
          
          echo ">>> Compilando React..."
          npm run build
          
          # 4. INYECCIÃ“N
          echo ">>> Inyectando en Android Assets..."
          rm -rf app/src/main/assets
          mkdir -p app/src/main/assets
          
          if [ -d "dist" ]; then
            cp -r dist/* app/src/main/assets/
            echo "âœ… UI Inyectada."
          else
            echo "âš ï¸ ERROR CRÃTICO: React build fallÃ³."
            exit 1
          fi

      # 5. ðŸ˜ REPARACIÃ“N AUTOMÃTICA DE GRADLE WRAPPER
      - name: ðŸ˜ Fix Missing Gradle Wrapper
        run: |
          mkdir -p gradle/wrapper
          cat > gradle/wrapper/gradle-wrapper.properties <<EOF
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-9.3-bin.zip
          networkTimeout=10000
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
          
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            wget -q https://raw.githubusercontent.com/gradle/gradle/master/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar
          fi

      # 6. ðŸŽ¨ GENERACIÃ“N DE RECURSOS
      - name: ðŸŽ¨ Generate Resources
        run: |
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/drawable
          
          echo '<resources><string name="app_name">Axiom VPN X</string></resources>' > app/src/main/res/values/strings.xml
          
          cat <<EOF > app/src/main/res/values/themes.xml
          <resources>
              <style name="Theme.AxiomLink" parent="android:Theme.Material.NoActionBar.Fullscreen">
                  <item name="android:statusBarColor">#050505</item>
                  <item name="android:navigationBarColor">#050505</item>
              </style>
          </resources>
          EOF
          
          cat <<EOF > app/src/main/res/drawable/ic_launcher.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108"><path android:fillColor="#1f538d" android:pathData="M0,0h108v108h-108z"/></vector>
          EOF
          cp app/src/main/res/drawable/ic_launcher.xml app/src/main/res/drawable/ic_launcher_round.xml
          cp app/src/main/res/drawable/ic_launcher.xml app/src/main/res/drawable/ic_notification.xml

      # 7. ðŸ”§ PERMISOS
      - name: ðŸ”§ Grant Permissions
        run: chmod +x gradlew

      # 8. ðŸ”¨ COMPILAR
      - name: ðŸ”¨ Build Debug APK
        run: ./gradlew assembleDebug --stacktrace --warning-mode=all

      # 9. ðŸ“¥ SUBIR
      - name: ðŸ“¥ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AxiomVPN-X-Debug
          path: app/build/outputs/apk/debug/*.apk
