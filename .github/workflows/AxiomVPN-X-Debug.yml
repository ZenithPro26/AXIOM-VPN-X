name: üí† AxiomVPN-X-Debug

on:
  push:
    branches: [ "main" ]
  # workflow_dispatch:
  workflow_dispatch:
    # inputs:
      # logLevel:
        # description: 'Nivel de Log'
        # required: false
        # default: 'warning'

jobs:
  build-axiom-ultimate:
    runs-on: ubuntu-latest
    
    steps:
      # 1. üõ∞Ô∏è OBTENER C√ìDIGO
      - name: üõ∞Ô∏è Checkout Repository
        uses: actions/checkout@v4

      # 2. ‚òï PREPARAR ENTORNO (Java 21 OBLIGATORIO para AGP 9.0+)
      - name: ‚òï Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      # 3. ‚öõÔ∏è PREPARAR NODE.JS
      - name: ‚öõÔ∏è Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 4. üß† CONSTRUIR UI (REACT) + INYECCI√ìN
      - name: üß† Build React UI & Inject Assets
        run: |
          echo ">>> Instalando dependencias..."
          npm install --legacy-peer-deps
          
          echo ">>> Construyendo Frontend (Vite)..."
          npm run build
          
          echo ">>> Limpiando e Inyectando Assets..."
          rm -rf app/src/main/assets
          mkdir -p app/src/main/assets
          
          if [ -d "dist" ]; then
            cp -r dist/* app/src/main/assets/
            echo "‚úÖ UI Inyectada: $(ls app/src/main/assets/ | wc -l) archivos."
          else
            echo "‚ö†Ô∏è Fall√≥ build de React. Creando fallback..."
            echo "<html><body style='background:#000;color:#1f538d'><h1>AXIOM CORE</h1></body></html>" > app/src/main/assets/index.html
          fi

      # 5. üêò GENERACI√ìN DE RECURSOS (TU APORTE MEJORADO)
      - name: üêò Generate Missing Resources (Self-Healing)
        run: |
          echo ">>> Generando estructura de recursos..."
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/drawable
          
          # A. Strings
          echo ">>> Creando strings.xml..."
          echo '<resources><string name="app_name">Axiom Link</string></resources>' > app/src/main/res/values/strings.xml
          
          # B. Tema (Cyber-Dark compatible)
          echo ">>> Creando themes.xml..."
          cat <<EOF > app/src/main/res/values/themes.xml
          <resources>
              <!-- Tema base sin ActionBar para pantalla completa -->
              <style name="Theme.AxiomLink" parent="android:Theme.Material.NoActionBar.Fullscreen">
                  <item name="android:statusBarColor">#000000</item>
                  <item name="android:navigationBarColor">#000000</item>
              </style>
          </resources>
          EOF
          
          # C. Icono de Notificaci√≥n (Minimalista)
          echo ">>> Creando ic_notification.xml..."
          cat <<EOF > app/src/main/res/drawable/ic_notification.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="24dp" android:height="24dp" android:viewportWidth="24" android:viewportHeight="24">
              <path android:fillColor="#FFFFFF" android:pathData="M12,2L4,5V10C4,15.25 7.5,20.1 12,22C16.5,20.1 20,15.25 20,10V5L12,2Z"/>
          </vector>
          EOF

          # D. Icono de Launcher (Vectorial Azul AXIOM)
          echo ">>> Creando ic_launcher.xml..."
          cat <<EOF > app/src/main/res/drawable/ic_launcher.xml
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#050505" android:pathData="M0,0h108v108h-108z"/> <!-- Fondo Oscuro -->
              <path android:fillColor="#1f538d" android:pathData="M54,24L24,36V56C24,77 38,96 54,104C70,96 84,77 84,56V36L54,24Z"/> <!-- Escudo Azul -->
          </vector>
          EOF
          
          # E. Icono Redondo (Clonamos el launcher para evitar errores en Android 12+)
          cp app/src/main/res/drawable/ic_launcher.xml app/src/main/res/drawable/ic_launcher_round.xml
          
          echo "‚úÖ Recursos generados y blindados."

      # 6. üîß PERMISOS DE GRADLE
      - name: üîß Fix Gradle Permissions
        run: chmod +x gradlew

      # 7. üî® COMPILAR APK (Modo Debug)
      - name: üî® Build Debug APK
        run: ./gradlew assembleDebug --stacktrace --warning-mode=all

      # 8. üì• SUBIR ARTEFACTO
      - name: üì• Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AxiomVPN-X-Debug
          path: app/build/outputs/apk/debug/*.apk
